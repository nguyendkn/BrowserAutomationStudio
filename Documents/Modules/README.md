# Module Development Guide

This guide provides comprehensive information for developing custom modules for BrowserAutomationStudio, including module architecture, APIs, and best practices.

## üìã Table of Contents

- [Module Architecture](#module-architecture)
- [Creating a New Module](#creating-a-new-module)
- [Module Components](#module-components)
- [JavaScript API](#javascript-api)
- [Native Extensions](#native-extensions)
- [Testing Modules](#testing-modules)
- [Publishing Modules](#publishing-modules)

## üèóÔ∏è Module Architecture

### Module Structure

A BAS module consists of several components:

```
ModuleName/
‚îú‚îÄ‚îÄ js/                          # JavaScript implementation
‚îÇ   ‚îú‚îÄ‚îÄ manifest.json           # Module metadata and configuration
‚îÇ   ‚îú‚îÄ‚îÄ action_interface.js     # UI interface definitions
‚îÇ   ‚îú‚îÄ‚îÄ action_select.js        # Code generation logic
‚îÇ   ‚îú‚îÄ‚îÄ action_code.js          # Runtime implementation
‚îÇ   ‚îî‚îÄ‚îÄ localization/           # Translation files
‚îú‚îÄ‚îÄ cpp/                        # Native C++ extensions (optional)
‚îÇ   ‚îú‚îÄ‚îÄ module.h               # Header files
‚îÇ   ‚îú‚îÄ‚îÄ module.cpp             # Implementation
‚îÇ   ‚îî‚îÄ‚îÄ CMakeLists.txt         # Build configuration
‚îú‚îÄ‚îÄ resources/                  # Static resources
‚îÇ   ‚îú‚îÄ‚îÄ icons/                 # Module icons
‚îÇ   ‚îú‚îÄ‚îÄ images/                # UI images
‚îÇ   ‚îî‚îÄ‚îÄ templates/             # Code templates
‚îî‚îÄ‚îÄ tests/                     # Module tests
    ‚îú‚îÄ‚îÄ unit/                  # Unit tests
    ‚îî‚îÄ‚îÄ integration/           # Integration tests
```

### Module Lifecycle

1. **Discovery**: BAS scans module directories
2. **Loading**: Manifest is parsed and validated
3. **Registration**: Actions are registered with the system
4. **Initialization**: Module initialization code runs
5. **Execution**: Actions are available for use
6. **Cleanup**: Module cleanup on shutdown

## üÜï Creating a New Module

### Step 1: Module Directory Setup

```bash
# Create module directory
mkdir Solution/Modules/MyCustomModule
cd Solution/Modules/MyCustomModule

# Create subdirectories
mkdir js cpp resources tests
mkdir js/localization resources/icons tests/unit tests/integration
```

### Step 2: Basic Manifest

Create `js/manifest.json`:

```json
{
    "name": "MyCustomModule",
    "description": "Custom module for specific automation tasks",
    "description_small": {
        "en": "Custom Module",
        "ru": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –º–æ–¥—É–ª—å"
    },
    "icon": "custom_module.png",
    "major_version": 1,
    "minor_version": 0,
    "developer_name": "Your Name",
    "developer_email": "your.email@example.com",
    "developer_site": "https://yourwebsite.com",
    "api_version": 1,
    "actions": [
        {
            "name": "CustomAction",
            "description": {
                "en": "Perform custom action",
                "ru": "–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ"
            },
            "template": "{{Input}} -> {{Output}}",
            "is_element": false,
            "interface": "custom_action_interface.js",
            "select": "custom_action_select.js",
            "code": [
                {
                    "file": "custom_action_code.js",
                    "name": "custom_action_code"
                }
            ]
        }
    ],
    "autogenerated_functions": [
        "CustomAction"
    ],
    "depends": [],
    "engine": [],
    "browser": [],
    "localize": {
        "Input parameter": {
            "ru": "–í—Ö–æ–¥–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä"
        },
        "Output variable": {
            "ru": "–í—ã—Ö–æ–¥–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è"
        }
    }
}
```

### Step 3: Action Interface

Create `js/custom_action_interface.js`:

```javascript
function GetInterface() {
    return {
        "InputParameter": {
            "type": "string",
            "description": {
                "en": "Input parameter for processing",
                "ru": "–í—Ö–æ–¥–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"
            },
            "default": "",
            "required": true
        },
        "ProcessingMode": {
            "type": "select",
            "description": {
                "en": "Processing mode",
                "ru": "–†–µ–∂–∏–º –æ–±—Ä–∞–±–æ—Ç–∫–∏"
            },
            "options": [
                {"value": "simple", "text": {"en": "Simple", "ru": "–ü—Ä–æ—Å—Ç–æ–π"}},
                {"value": "advanced", "text": {"en": "Advanced", "ru": "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π"}}
            ],
            "default": "simple"
        },
        "OutputVariable": {
            "type": "variable",
            "description": {
                "en": "Variable to store result",
                "ru": "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"
            }
        },
        "EnableLogging": {
            "type": "boolean",
            "description": {
                "en": "Enable detailed logging",
                "ru": "–í–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ"
            },
            "default": false
        }
    };
}
```

### Step 4: Code Generation

Create `js/custom_action_select.js`:

```javascript
function GetCode(loader) {
    // Get input parameters
    var inputParam = GetInputConstructorValue("InputParameter", loader);
    var processingMode = GetInputConstructorValue("ProcessingMode", loader);
    var outputVar = GetInputConstructorValue("OutputVariable", loader);
    var enableLogging = GetInputConstructorValue("EnableLogging", loader);
    
    // Validate required parameters
    if (inputParam["original"].length == 0) {
        Invalid(tr("The parameter \"") + tr("Input parameter") + tr("\" is not specified"));
        return;
    }
    
    if (outputVar["original"].length == 0) {
        Invalid(tr("The parameter \"") + tr("Output variable") + tr("\" is not specified"));
        return;
    }
    
    try {
        // Generate code from template
        var code = loader.GetAdditionalData() + _.template($("#custom_action_code").html())({
            "InputParameter": inputParam["updated"],
            "ProcessingMode": processingMode["updated"],
            "OutputVariable": outputVar["updated"],
            "EnableLogging": enableLogging["updated"]
        });
        
        // Normalize and append code
        code = Normalize(code, 0);
        BrowserAutomationStudio_Append("", BrowserAutomationStudio_SaveControls() + code, action, DisableIfAdd);
        
    } catch(e) {
        Invalid("Code generation error: " + e.message);
    }
}
```

### Step 5: Runtime Implementation

Create `js/custom_action_code.js`:

```javascript
<script type="text/template" id="custom_action_code">
try {
    // Get input parameters
    var inputData = {{InputParameter}};
    var mode = {{ProcessingMode}};
    var enableLogging = {{EnableLogging}};
    
    if (enableLogging) {
        console.log("CustomAction: Processing input with mode: " + mode);
    }
    
    // Validate input
    if (!inputData || inputData.length === 0) {
        throw new Error("Input parameter is empty or invalid");
    }
    
    var result;
    
    // Process based on mode
    if (mode === "simple") {
        result = processSimple(inputData);
    } else if (mode === "advanced") {
        result = processAdvanced(inputData);
    } else {
        throw new Error("Unknown processing mode: " + mode);
    }
    
    // Store result
    {{OutputVariable}} = result;
    
    if (enableLogging) {
        console.log("CustomAction: Processing completed successfully");
    }
    
} catch (error) {
    console.error("CustomAction error: " + error.message);
    throw error;
}

// Helper functions
function processSimple(input) {
    // Simple processing logic
    return input.toUpperCase();
}

function processAdvanced(input) {
    // Advanced processing logic
    return input.split('').reverse().join('');
}
</script>
```

## üîß Module Components

### Interface Types

#### String Input
```javascript
"ParameterName": {
    "type": "string",
    "description": {"en": "Description", "ru": "–û–ø–∏—Å–∞–Ω–∏–µ"},
    "default": "",
    "required": true,
    "multiline": false,
    "placeholder": "Enter value..."
}
```

#### Select/Dropdown
```javascript
"SelectParameter": {
    "type": "select",
    "description": {"en": "Select option", "ru": "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é"},
    "options": [
        {"value": "option1", "text": {"en": "Option 1", "ru": "–û–ø—Ü–∏—è 1"}},
        {"value": "option2", "text": {"en": "Option 2", "ru": "–û–ø—Ü–∏—è 2"}}
    ],
    "default": "option1"
}
```

#### Boolean Checkbox
```javascript
"BooleanParameter": {
    "type": "boolean",
    "description": {"en": "Enable feature", "ru": "–í–∫–ª—é—á–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é"},
    "default": false
}
```

#### Variable Reference
```javascript
"VariableParameter": {
    "type": "variable",
    "description": {"en": "Variable name", "ru": "–ò–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π"}
}
```

#### File Path
```javascript
"FileParameter": {
    "type": "file",
    "description": {"en": "File path", "ru": "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É"},
    "extensions": ["txt", "csv", "json"],
    "mode": "open" // or "save"
}
```

### Advanced Features

#### Conditional Parameters
```javascript
function GetInterface() {
    var interface = {
        "Mode": {
            "type": "select",
            "options": [
                {"value": "file", "text": {"en": "File", "ru": "–§–∞–π–ª"}},
                {"value": "url", "text": {"en": "URL", "ru": "URL"}}
            ]
        }
    };
    
    // Add conditional parameters based on mode
    if (GetCurrentParameterValue("Mode") === "file") {
        interface["FilePath"] = {
            "type": "file",
            "description": {"en": "File path", "ru": "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É"}
        };
    } else if (GetCurrentParameterValue("Mode") === "url") {
        interface["URL"] = {
            "type": "string",
            "description": {"en": "URL address", "ru": "URL –∞–¥—Ä–µ—Å"}
        };
    }
    
    return interface;
}
```

#### Parameter Validation
```javascript
function ValidateParameters(parameters) {
    var errors = [];
    
    // Validate URL format
    if (parameters.Mode === "url" && parameters.URL) {
        var urlPattern = /^https?:\/\/.+/;
        if (!urlPattern.test(parameters.URL)) {
            errors.push("Invalid URL format");
        }
    }
    
    // Validate file existence
    if (parameters.Mode === "file" && parameters.FilePath) {
        if (!FileExists(parameters.FilePath)) {
            errors.push("File does not exist: " + parameters.FilePath);
        }
    }
    
    return errors;
}
```

## üîå Native Extensions

### C++ Module Extension

#### Header File (`cpp/module.h`)
```cpp
#ifndef CUSTOM_MODULE_H
#define CUSTOM_MODULE_H

#include <QString>
#include <QJsonObject>

extern "C" {
    // Module lifecycle functions
    __declspec(dllexport) void StartDll();
    __declspec(dllexport) void EndDll();
    __declspec(dllexport) void StartThread();
    __declspec(dllexport) void EndThread();
    
    // Module functions
    __declspec(dllexport) QString ProcessData(const QString& input, const QJsonObject& options);
    __declspec(dllexport) bool ValidateInput(const QString& input);
}

class CustomModuleProcessor {
public:
    static QString ProcessSimple(const QString& input);
    static QString ProcessAdvanced(const QString& input, const QJsonObject& options);
    static bool IsValidInput(const QString& input);
    
private:
    static void InitializeProcessor();
    static void CleanupProcessor();
};

#endif // CUSTOM_MODULE_H
```

#### Implementation (`cpp/module.cpp`)
```cpp
#include "module.h"
#include <QDebug>
#include <QRegularExpression>

// Module lifecycle
void StartDll() {
    qDebug() << "CustomModule: DLL started";
    CustomModuleProcessor::InitializeProcessor();
}

void EndDll() {
    qDebug() << "CustomModule: DLL ending";
    CustomModuleProcessor::CleanupProcessor();
}

void StartThread() {
    // Thread-specific initialization
}

void EndThread() {
    // Thread-specific cleanup
}

// Exported functions
QString ProcessData(const QString& input, const QJsonObject& options) {
    try {
        QString mode = options.value("mode").toString("simple");
        
        if (mode == "simple") {
            return CustomModuleProcessor::ProcessSimple(input);
        } else if (mode == "advanced") {
            return CustomModuleProcessor::ProcessAdvanced(input, options);
        } else {
            return QString("Error: Unknown processing mode");
        }
    } catch (const std::exception& e) {
        return QString("Error: %1").arg(e.what());
    }
}

bool ValidateInput(const QString& input) {
    return CustomModuleProcessor::IsValidInput(input);
}

// Implementation class
void CustomModuleProcessor::InitializeProcessor() {
    // Initialize any required resources
}

void CustomModuleProcessor::CleanupProcessor() {
    // Cleanup resources
}

QString CustomModuleProcessor::ProcessSimple(const QString& input) {
    return input.toUpper();
}

QString CustomModuleProcessor::ProcessAdvanced(const QString& input, const QJsonObject& options) {
    QString result = input;
    
    // Apply transformations based on options
    if (options.value("reverse").toBool()) {
        std::reverse(result.begin(), result.end());
    }
    
    if (options.value("removeSpaces").toBool()) {
        result.remove(' ');
    }
    
    return result;
}

bool CustomModuleProcessor::IsValidInput(const QString& input) {
    return !input.isEmpty() && input.length() <= 10000;
}
```

#### DLL Configuration in Manifest
```json
{
    "dll": [
        {
            "name": "custom_module",
            "filename32": "custom_module32.dll",
            "filename64": "custom_module64.dll",
            "startdllfunction": "StartDll",
            "enddllfunction": "EndDll",
            "startthreadfunction": "StartThread",
            "endthreadfunction": "EndThread",
            "exportlist": [
                {
                    "name": "process_data",
                    "isasync": false,
                    "waitinfinite": false,
                    "workfunction": "ProcessData"
                },
                {
                    "name": "validate_input",
                    "isasync": false,
                    "waitinfinite": false,
                    "workfunction": "ValidateInput"
                }
            ]
        }
    ]
}
```

#### Using Native Functions in JavaScript
```javascript
// Call native function
var result = custom_module.process_data(inputData, {
    mode: "advanced",
    reverse: true,
    removeSpaces: false
});

// Validate input using native function
if (!custom_module.validate_input(inputData)) {
    throw new Error("Invalid input data");
}
```

## üß™ Testing Modules

### Unit Testing

#### JavaScript Tests
```javascript
// tests/unit/custom_action_test.js
describe('CustomAction', function() {
    beforeEach(function() {
        // Setup test environment
    });
    
    it('should process simple input correctly', function() {
        var input = "hello world";
        var result = processSimple(input);
        expect(result).toBe("HELLO WORLD");
    });
    
    it('should handle empty input', function() {
        expect(function() {
            processSimple("");
        }).toThrow();
    });
    
    it('should process advanced input with options', function() {
        var input = "hello";
        var result = processAdvanced(input);
        expect(result).toBe("olleh");
    });
});
```

#### Integration Tests
```javascript
// tests/integration/module_integration_test.js
describe('Module Integration', function() {
    var testBrowser;
    
    beforeEach(function() {
        testBrowser = createTestBrowser();
    });
    
    afterEach(function() {
        testBrowser.close();
    });
    
    it('should integrate with BAS engine', function() {
        // Test module integration with BAS
        var script = 'CustomAction("test input", "simple", "result");';
        var result = testBrowser.executeScript(script);
        
        expect(result.success).toBe(true);
        expect(result.variables.result).toBe("TEST INPUT");
    });
});
```

### Manual Testing

#### Test Script Template
```javascript
// Create test script for manual testing
try {
    console.log("Testing CustomAction module...");
    
    // Test case 1: Simple processing
    CustomAction("hello world", "simple", "result1", false);
    console.log("Test 1 result:", result1);
    
    // Test case 2: Advanced processing
    CustomAction("hello world", "advanced", "result2", true);
    console.log("Test 2 result:", result2);
    
    // Test case 3: Error handling
    try {
        CustomAction("", "simple", "result3", false);
    } catch (e) {
        console.log("Expected error:", e.message);
    }
    
    console.log("All tests completed successfully!");
    
} catch (error) {
    console.error("Test failed:", error.message);
}
```

## üì¶ Publishing Modules

### Module Package Structure
```
MyCustomModule-1.0.zip
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ custom_action_interface.js
‚îú‚îÄ‚îÄ custom_action_select.js
‚îú‚îÄ‚îÄ custom_action_code.js
‚îú‚îÄ‚îÄ custom_module32.dll
‚îú‚îÄ‚îÄ custom_module64.dll
‚îú‚îÄ‚îÄ icons/
‚îÇ   ‚îî‚îÄ‚îÄ custom_module.png
‚îî‚îÄ‚îÄ documentation/
    ‚îú‚îÄ‚îÄ README.md
    ‚îî‚îÄ‚îÄ examples/
```

### Distribution Guidelines

1. **Version Management**: Use semantic versioning (major.minor.patch)
2. **Documentation**: Include comprehensive documentation
3. **Examples**: Provide usage examples
4. **Testing**: Include test cases and validation
5. **Compatibility**: Specify BAS version compatibility
6. **Dependencies**: Document any external dependencies

### Module Registry

Modules can be distributed through:
- Official BAS module repository
- Community forums
- Direct distribution
- Custom module repositories

---

*For more examples and advanced techniques, see the [Examples](../Examples/README.md) section*
